import React, { useState, useMemo } from 'react'

// TicketingApp.jsx
// Single-file React component demo for a modern ticketing site.
// TailwindCSS + shadcn/ui style classes are used (no imports required in this snippet).
// Features included:
// - Event listing grid
// - Event detail drawer with seat map
// - Seat selection logic
// - Cart & checkout form (client-side demo)
// - Responsive layout, accessible controls

export default function TicketingApp() {
  const sampleEvents = [
    {
      id: 'e1',
      title: '弦樂四重奏之夜',
      venue: '國家音樂廳',
      date: '2026-02-14',
      time: '19:30',
      priceBase: 1200,
      img: 'https://placehold.co/600x400?text=Quintet',
      rows: 6,
      cols: 10,
    },
    {
      id: 'e2',
      title: '浪漫鋼琴獨奏',
      venue: '城市表演廳',
      date: '2026-03-05',
      time: '14:00',
      priceBase: 900,
      img: 'https://placehold.co/600x400?text=Piano',
      rows: 5,
      cols: 8,
    },
    {
      id: 'e3',
      title: '當代音樂晚會',
      venue: '藝文中心',
      date: '2026-04-20',
      time: '20:00',
      priceBase: 600,
      img: 'https://placehold.co/600x400?text=Contemporary',
      rows: 8,
      cols: 12,
    },
  ]

  const [events] = useState(sampleEvents)
  const [selectedEvent, setSelectedEvent] = useState(null)
  const [cart, setCart] = useState([])
  const [showCheckout, setShowCheckout] = useState(false)

  function openEvent(e) {
    setSelectedEvent(e)
  }

  function addToCart(item) {
    setCart((c) => [...c, item])
    setSelectedEvent(null)
  }

  function removeFromCart(index) {
    setCart((c) => c.filter((_, i) => i !== index))
  }

  const total = useMemo(() => cart.reduce((s, it) => s + it.price, 0), [cart])

  return (
    <div className="min-h-screen bg-white text-gray-800">
      <Navbar cartCount={cart.length} onOpenCart={() => setShowCheckout(true)} />

      <main className="container mx-auto p-6">
        <header className="mb-6 text-center">
          <h1 className="text-3xl font-bold">線上購票平台</h1>
          <p className="text-gray-500 mt-2">快速選位、即時結帳、票券 QR 下載</p>
        </header>

        <section>
          <h2 className="sr-only">活動列表</h2>
          <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {events.map((ev) => (
              <EventCard key={ev.id} ev={ev} onOpen={() => openEvent(ev)} />
            ))}
          </div>
        </section>
      </main>

      <Footer />

      {selectedEvent && (
        <EventDrawer
          ev={selectedEvent}
          onClose={() => setSelectedEvent(null)}
          onAdd={addToCart}
        />
      )}

      {showCheckout && (
        <CheckoutModal
          cart={cart}
          onClose={() => setShowCheckout(false)}
          onRemove={removeFromCart}
          total={total}
        />
      )}
    </div>
  )
}

/* ------------------------- UI Subcomponents ------------------------- */

function Navbar({ cartCount, onOpenCart }) {
  return (
    <nav className="bg-white border-b">
      <div className="container mx-auto p-4 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <div className="logo text-xl font-semibold">星韻票務</div>
          <ul className="hidden md:flex gap-4 text-sm text-gray-600">
            <li>活動</li>
            <li>購票說明</li>
            <li>常見問題</li>
          </ul>
        </div>

        <div className="flex items-center gap-3">
          <button
            onClick={onOpenCart}
            className="relative inline-flex items-center gap-2 px-4 py-2 rounded-2xl border shadow-sm"
            aria-label="打開購物車"
          >
            購物車
            <span className="ml-1 inline-flex items-center justify-center w-6 h-6 rounded-full text-sm bg-amber-200">{cartCount}</span>
          </button>
        </div>
      </div>
    </nav>
  )
}

function EventCard({ ev, onOpen }) {
  return (
    <article className="card team-card overflow-hidden rounded-2xl shadow-sm">
      <img src={ev.img} alt={ev.title} className="w-full h-48 object-cover" />
      <div className="p-4">
        <h3 className="font-semibold text-lg">{ev.title}</h3>
        <p className="text-sm text-gray-500">{ev.venue} • {ev.date} • {ev.time}</p>
        <div className="mt-4 flex items-center justify-between">
          <div>
            <div className="text-amber-600 font-semibold">NT$ {ev.priceBase}</div>
            <div className="text-xs text-gray-400">依座位區域價格不同</div>
          </div>
          <div>
            <button onClick={onOpen} className="px-4 py-2 rounded-full border">購票</button>
          </div>
        </div>
      </div>
    </article>
  )
}

function EventDrawer({ ev, onClose, onAdd }) {
  // seat map: rows x cols; we'll mark some seats as taken randomly for demo
  const [selectedSeats, setSelectedSeats] = useState([])
  const rows = ev.rows
  const cols = ev.cols

  // generate taken seats deterministic from id for demo
  function isTaken(r, c) {
    const seed = ev.id.charCodeAt(1) + r * 13 + c * 7
    return seed % 11 === 0
  }

  function toggleSeat(r, c) {
    const seatId = `${r}-${c}`
    if (isTaken(r, c)) return
    setSelectedSeats((s) => (s.includes(seatId) ? s.filter((x) => x !== seatId) : [...s, seatId]))
  }

  function confirmSelection() {
    if (selectedSeats.length === 0) {
      alert('請選擇至少一個座位')
      return
    }
    // price increases slightly for front rows
    const items = selectedSeats.map((sid) => {
      const [r, c] = sid.split('-').map(Number)
      const multiplier = r <= 2 ? 1.3 : r <= 4 ? 1.1 : 1.0
      const price = Math.round(ev.priceBase * multiplier)
      return { evId: ev.id, evTitle: ev.title, seat: `R${r}C${c}`, price }
    })
    items.forEach((it) => onAdd(it))
  }

  return (
    <div className="fixed inset-0 z-50 flex">
      <div className="backdrop-blur-sm bg-black/20 flex-1" onClick={onClose}></div>
      <aside className="w-full max-w-2xl bg-white p-6 shadow-2xl overflow-auto">
        <div className="flex items-start justify-between">
          <div>
            <h2 className="text-2xl font-bold">{ev.title}</h2>
            <p className="text-sm text-gray-500">{ev.venue} • {ev.date} • {ev.time}</p>
          </div>
          <button onClick={onClose} className="text-gray-500">關閉</button>
        </div>

        <div className="mt-6">
          <h3 className="font-semibold mb-2">座位選擇</h3>
          <div className="w-full bg-gray-50 p-3 rounded-lg mb-4 text-center text-xs text-gray-400">舞台 Stage</div>

          <div className="overflow-auto">
            <div className="inline-block">
              {Array.from({ length: rows }).map((_, r) => (
                <div key={r} className="flex gap-2 mb-2 justify-center">
                  {Array.from({ length: cols }).map((_, c) => {
                    const taken = isTaken(r + 1, c + 1)
                    const id = `${r + 1}-${c + 1}`
                    const selected = selectedSeats.includes(id)
                    return (
                      <button
                        key={c}
                        onClick={() => toggleSeat(r + 1, c + 1)}
                        disabled={taken}
                        className={`w-10 h-8 rounded-md text-xs border flex items-center justify-center ${
                          taken ? 'bg-gray-300 cursor-not-allowed' : selected ? 'bg-amber-400' : 'bg-white hover:bg-amber-50'
                        }`}
                        aria-pressed={selected}
                        title={taken ? '已售出' : `第 ${r + 1} 排，第 ${c + 1} 欄`}
                      >
                        {r + 1}-{c + 1}
                      </button>
                    )
                  })}
                </div>
              ))}
            </div>
          </div>

          <div className="mt-4 flex items-center justify-between">
            <div className="text-sm text-gray-600">已選：{selectedSeats.length} 席</div>
            <div className="flex gap-2">
              <button onClick={() => setSelectedSeats([])} className="px-3 py-2 border rounded">清除</button>
              <button onClick={confirmSelection} className="px-4 py-2 rounded-full bg-amber-500 text-white">加入購物車</button>
            </div>
          </div>
        </div>

        <div className="mt-6 border-t pt-4 text-sm text-gray-500">價格說明：前排價格較高，票價包含服務費。購買完成後請於活動當日出示 QR 票券。</div>
      </aside>
    </div>
  )
}

function CheckoutModal({ cart, onClose, onRemove, total }) {
  const [name, setName] = useState('')
  const [email, setEmail] = useState('')
  const [agreed, setAgreed] = useState(true)

  function payNow() {
    if (!name || !email) {
      alert('請填寫聯絡資料')
      return
    }
    // Demo: pretend to process payment
    alert(`付款成功！ 已購買 ${cart.length} 張，總計 NT$ ${total}`)
    onClose()
  }

  return (
    <div className="fixed inset-0 z-60 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/30" onClick={onClose}></div>
      <div className="relative bg-white rounded-2xl shadow-xl w-full max-w-3xl p-6">
        <h3 className="text-xl font-semibold">結帳</h3>
        <div className="mt-4 grid gap-4 md:grid-cols-2">
          <div>
            <h4 className="font-medium">訂單明細</h4>
            <ul className="mt-2 space-y-2">
              {cart.map((it, i) => (
                <li key={i} className="flex items-center justify-between border rounded p-2">
                  <div>
                    <div className="font-medium text-sm">{it.evTitle}</div>
                    <div className="text-xs text-gray-500">{it.seat}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="text-sm font-semibold">NT$ {it.price}</div>
                    <button onClick={() => onRemove(i)} className="text-xs text-red-500">移除</button>
                  </div>
                </li>
              ))}
            </ul>
            <div className="mt-3 text-right font-semibold">小計 NT$ {total}</div>
          </div>

          <div>
            <h4 className="font-medium">聯絡資訊</h4>
            <label className="block text-xs mt-2">姓名</label>
            <input value={name} onChange={(e) => setName(e.target.value)} className="w-full border rounded px-3 py-2" />
            <label className="block text-xs mt-2">Email</label>
            <input value={email} onChange={(e) => setEmail(e.target.value)} className="w-full border rounded px-3 py-2" />

            <label className="flex items-center gap-2 mt-3 text-sm">
              <input type="checkbox" checked={agreed} onChange={(e) => setAgreed(e.target.checked)} /> 我同意購票條款
            </label>

            <div className="mt-4 flex gap-3">
              <button onClick={onClose} className="px-4 py-2 border rounded">返回</button>
              <button onClick={payNow} className="px-4 py-2 bg-amber-500 text-white rounded">付款 NT$ {total}</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}

function Footer() {
  return (
    <footer className="border-t mt-12">
      <div className="container mx-auto p-6 text-sm text-gray-500 text-center">© 2026 星韻票務 • 聯絡信箱: info@example.com</div>
    </footer>
  )
}
